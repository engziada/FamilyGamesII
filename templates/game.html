{% extends "base.html" %}

{% block content %}
<div class="game-container">
    <!-- Hidden inputs for game data -->
    <input type="hidden" id="game-id" value="{{ game_id }}">
    <input type="hidden" id="player-name" value="{{ player_name }}">
    <input type="hidden" id="transfer-id" value="{{ transfer_id }}">
    <input type="hidden" id="is-host" value="{{ 'true' if is_host else 'false' }}">

    <div class="game-board">
        <div class="status-bar">
            <div class="turn-indicator">
                <i class="fas fa-user-circle"></i>
                الدور على: <span id="current-turn">...</span>
            </div>
            <div id="timer" class="timer-box">
                <i class="fas fa-clock"></i>
                <span>02:00</span>
            </div>
        </div>

        <div class="display-area card">
            <div id="item-display" class="item-card animate-jelly u-hidden u-full-width">
                <!-- Content populated by JS -->
            </div>

            <!-- Pictionary Canvas -->
            <div id="pictionary-area" class="u-hidden u-full-width" style="position: relative;">
                <div class="canvas-controls u-flex-center u-margin-bottom">
                    <button class="btn btn-outline" onclick="window.gameInstance.clearCanvas()" id="clear-btn" style="padding: 0.8rem 1.2rem;"><i class="fas fa-eraser"></i> مسح</button>
                    <input type="color" id="draw-color" value="#FF6B6B" style="width: 50px; height: 50px; border: 3px solid var(--text); border-radius: 15px; cursor: pointer; padding: 0;">
                    <input type="range" id="draw-size" min="1" max="20" value="5" class="input-control" style="width: 120px; min-height: auto; padding: 0.5rem;">
                </div>
                <canvas id="game-canvas" width="600" height="400" style="border: 4px solid var(--text); border-radius: 20px 60px; background: white; cursor: crosshair; width: 100%; height: auto; touch-action: none; box-shadow: var(--shadow-pop);"></canvas>
            </div>

            <!-- Bus Complete Area -->
            <div id="bus-area" class="u-hidden u-full-width">
                <div class="bus-header u-flex-center u-margin-bottom">
                    <div class="letter-display">الحرف: <span id="current-letter" style="font-size: 3rem; color: var(--primary); font-weight: 800;">?</span></div>
                </div>
                <div class="bus-grid">
                    <div class="input-group">
                        <label>اسم</label>
                        <input type="text" class="bus-input" data-category="اسم" placeholder="...">
                    </div>
                    <div class="input-group">
                        <label>حيوان</label>
                        <input type="text" class="bus-input" data-category="حيوان" placeholder="...">
                    </div>
                    <div class="input-group">
                        <label>نبات</label>
                        <input type="text" class="bus-input" data-category="نبات" placeholder="...">
                    </div>
                    <div class="input-group">
                        <label>جماد</label>
                        <input type="text" class="bus-input" data-category="جماد" placeholder="...">
                    </div>
                    <div class="input-group">
                        <label>بلاد</label>
                        <input type="text" class="bus-input" data-category="بلاد" placeholder="...">
                    </div>
                    <div class="input-group">
                        <label>أكلة</label>
                        <input type="text" class="bus-input" data-category="أكلة" placeholder="...">
                    </div>
                    <div class="input-group">
                        <label>مهنة</label>
                        <input type="text" class="bus-input" data-category="مهنة" placeholder="...">
                    </div>
                </div>
                <div class="u-flex-center u-margin-top">
                    <button id="stopBusButton" class="btn btn-primary btn-large u-full-width animate-pulse" onclick="window.gameInstance.stopBus()">
                        <i class="fas fa-hand-paper"></i> أتوبيس كومبليت!
                    </button>
                </div>
            </div>

            <!-- Bus Results Area -->
            <div id="bus-results-area" class="u-hidden u-full-width">
                <h3 class="u-text-center u-margin-bottom">نتائج الجولة (حرف <span id="result-letter">?</span>)</h3>
                <div class="table-responsive">
                    <table class="bus-results-table" style="width: 100%; border-collapse: separate; border-spacing: 0 10px;">
                        <thead>
                            <tr id="results-header">
                                <th style="padding: 1rem;">اللاعب</th>
                                <!-- Category headers will be injected -->
                                <th style="padding: 1rem;">المجموع</th>
                            </tr>
                        </thead>
                        <tbody id="results-body">
                            <!-- Rows will be injected -->
                        </tbody>
                    </table>
                </div>
                <div id="host-bus-actions" class="u-hidden u-flex-center u-margin-top">
                    <button class="btn btn-primary" onclick="window.gameInstance.confirmBusScores()">
                        الجولة التالية <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
            </div>

            <div id="waiting-area" class="waiting-area u-text-center">
                <i class="fas fa-hourglass-start fa-3x animate-heartbeat" style="color: var(--secondary); margin-bottom: 2rem;"></i>
                <h3>في انتظار بدء الجولة...</h3>
            </div>

            <div class="game-actions u-flex-center u-full-width u-margin-top">
                <button id="readyButton" class="btn btn-primary u-hidden">
                    <i class="fas fa-play"></i> أنا جاهز!
                </button>
                <button id="passButton" class="btn btn-outline u-hidden">
                    <i class="fas fa-forward"></i> تخطي
                </button>
                <button id="guessButton" class="btn btn-secondary u-hidden">
                    <i class="fas fa-check"></i> عرفتها!
                </button>
            </div>
        </div>

        <div class="host-controls card u-flex-center" style="padding: 1.5rem;">
            {% if player_type == 'host' %}
            <button id="startButton" class="btn btn-primary" style="display: none;">
                <i class="fas fa-play-circle"></i> ابدأ اللعبة
            </button>
            <button id="nextButton" class="btn btn-secondary" style="display: none;">
                <i class="fas fa-step-forward"></i> الجولة التالية
            </button>
            <button id="close-room" class="btn btn-outline" style="color: white; background-color: var(--danger);">
                <i class="fas fa-times-circle"></i> إنهاء اللعبة
            </button>
            {% else %}
            <button id="leaveButton" class="btn btn-outline">
                <i class="fas fa-sign-out-alt"></i> انسحاب
            </button>
            {% endif %}
        </div>
    </div>

    <div class="sidebar">
        <div class="card player-list-card">
            <h4><i class="fas fa-users"></i> اللاعبين</h4>
            <div id="players-list">
                <!-- Populated by JS -->
            </div>
        </div>

        <div class="card score-card">
            <h4><i class="fas fa-trophy"></i> النتائج</h4>
            <div id="scores">
                <!-- Populated by JS -->
            </div>
        </div>

        <div class="card info-card" style="padding: 1.2rem; font-size: 0.9rem; color: var(--text-light); text-align: center;">
            <p>رقم الغرفة: <strong style="color: var(--primary);">{{ game_id }}</strong></p>
            <p>أنت تلعب بصفتك: <strong style="color: var(--secondary);">{{ player_name }}</strong></p>
        </div>
    </div>
</div>

<div id="game-status" class="u-hidden">
    <!-- Used for snackbar style notifications -->
</div>

<div id="error-message"></div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/charades.js') }}"></script>
{% endblock %}
