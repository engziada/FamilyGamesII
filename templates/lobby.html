{% extends "base.html" %}
{% block content %}
<div class="lobby-container">
    <h1>ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± - Ø§Ù„Ù„Ø¹Ø¨Ø© Ø±Ù‚Ù… {{ game_id }}</h1>
    
    <div class="players-list">
        <h2>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†:</h2>
        <ul id="players">
            <!-- Server-rendered players -->
            {% for player in players %}
            <li class="player-item">
                {{ player }}
                {% if player == host %} ğŸ‘‘ {% endif %}
                {% if player == player_name %} (Ø£Ù†Øª) {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Server-rendered controls -->
    {% if player_name == host %}
    <button id="startButton" onclick="startGame()">Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
    {% else %}
    <p class="waiting-message">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...</p>
    {% endif %}
</div>

<script>
    const socket = io();
    let gameState = {
        players: {{ players|tojson }},
        host: '{{ host }}'
    };

    // Initial render
    updatePlayerList(gameState.players, gameState.host);

    socket.on('connect', () => {
        console.log('Establishing secure connection...');
        socket.emit('verify_game', {
            game_id: '{{ game_id }}',
            player_name: '{{ player_name }}'
        });
    });

    socket.on('game_state', (data) => {
        console.log('Received game state:', data);
        gameState = data;
        updatePlayerList(data.players, data.host);
    });

    socket.on('invalid_game', () => {
        alert('Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©ØŒ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡');
        window.location.href = '/';
    });

    function updatePlayerList(players, host) {
        const list = document.getElementById('players');
        list.innerHTML = players.map(player => `
            <li class="player-item">
                ${player} 
                ${player === host ? 'ğŸ‘‘' : ''}
                ${player === '{{ player_name }}' ? ' (Ø£Ù†Øª)' : ''}
            </li>
        `).join('');
    }
</script>
{% endblock %}